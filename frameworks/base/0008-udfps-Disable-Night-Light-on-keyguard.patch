From 7a808a89c2c202497c0e6b985f4bbda6e75a4beb Mon Sep 17 00:00:00 2001
From: penglezos <panagiotisegl@gmail.com>
Date: Fri, 5 May 2023 19:40:13 +0300
Subject: [PATCH 1/2] udfps: Disable Night Light on keyguard

Change-Id: I62c1f7ed75a0f188acfbbb0aaa3e423ba2c833b2
Signed-off-by: penglezos <panagiotisegl@gmail.com>
---
 .../android/systemui/biometrics/UdfpsController.java  | 11 +++++++++++
 1 file changed, 11 insertions(+)

diff --git a/packages/SystemUI/src/com/android/systemui/biometrics/UdfpsController.java b/packages/SystemUI/src/com/android/systemui/biometrics/UdfpsController.java
index 48e06eef93a0..9705d244f8ff 100644
--- a/packages/SystemUI/src/com/android/systemui/biometrics/UdfpsController.java
+++ b/packages/SystemUI/src/com/android/systemui/biometrics/UdfpsController.java
@@ -30,6 +30,7 @@ import android.content.IntentFilter;
 import android.graphics.Point;
 import android.hardware.biometrics.BiometricFingerprintConstants;
 import android.hardware.biometrics.SensorProperties;
+import android.hardware.display.ColorDisplayManager;
 import android.hardware.display.DisplayManager;
 import android.hardware.fingerprint.FingerprintManager;
 import android.hardware.fingerprint.FingerprintSensorProperties;
@@ -120,6 +121,7 @@ public class UdfpsController implements DozeReceiver, Dumpable {
     // Minimum required delay between consecutive touch logs in milliseconds.
     private static final long MIN_TOUCH_LOG_INTERVAL = 50;
 
+    private final ColorDisplayManager mColorDisplayManager;
     private final Context mContext;
     private final Execution mExecution;
     private final FingerprintManager mFingerprintManager;
@@ -184,6 +186,7 @@ public class UdfpsController implements DozeReceiver, Dumpable {
     private boolean mOnFingerDown;
     private boolean mAttemptedToDismissKeyguard;
     private final Set<Callback> mCallbacks = new HashSet<>();
+    private boolean mNightDisplayEnabled;
 
     @VisibleForTesting
     public static final VibrationAttributes UDFPS_VIBRATION_ATTRIBUTES =
@@ -751,6 +754,7 @@ public class UdfpsController implements DozeReceiver, Dumpable {
         mConfigurationController = configurationController;
         mSystemClock = systemClock;
         mUnlockedScreenOffAnimationController = unlockedScreenOffAnimationController;
+        mColorDisplayManager = context.getSystemService(ColorDisplayManager.class);
         mLatencyTracker = latencyTracker;
         mActivityLaunchAnimator = activityLaunchAnimator;
         mAlternateTouchProvider = alternateTouchProvider.map(Provider::get).orElse(null);
@@ -828,6 +832,10 @@ public class UdfpsController implements DozeReceiver, Dumpable {
     }
 
     private void showUdfpsOverlay(@NonNull UdfpsControllerOverlay overlay) {
+        mNightDisplayEnabled = mColorDisplayManager.isNightDisplayActivated();
+        if (mNightDisplayEnabled) {
+            mColorDisplayManager.setNightDisplayActivated(false);
+        }
         mExecution.assertIsMainThread();
 
         mOverlay = overlay;
@@ -849,6 +857,9 @@ public class UdfpsController implements DozeReceiver, Dumpable {
     }
 
     private void hideUdfpsOverlay() {
+        if (mNightDisplayEnabled) {
+            mColorDisplayManager.setNightDisplayActivated(true);
+        }
         mExecution.assertIsMainThread();
 
         if (mOverlay != null) {
-- 
2.40.1

